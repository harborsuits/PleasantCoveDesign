<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pleasant Cove Design - Project Workspace</title>
    <style>
        /* Project Workspace Module Styles */
        .pcd-workspace {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            border-radius: 12px;
        }

        /* Header */
        .pcd-header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 40px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .pcd-header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
            font-weight: 700;
        }

        .pcd-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 18px;
        }

        /* Progress Bar */
        .pcd-progress-container {
            background: white;
            padding: 30px;
            margin: -20px 20px 20px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pcd-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .pcd-progress-bar {
            background: #e5e7eb;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }

        .pcd-progress-fill {
            background: linear-gradient(90deg, #4F46E5 0%, #7C3AED 100%);
            height: 100%;
            transition: width 0.5s ease;
            position: relative;
        }

        /* Status Cards */
        .pcd-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .pcd-status-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .pcd-status-card h3 {
            margin: 0 0 8px 0;
            color: #1f2937;
            font-size: 16px;
        }

        .pcd-status-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #4F46E5;
        }

        /* Tabs */
        .pcd-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pcd-tab {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
            position: relative;
        }

        .pcd-tab:hover {
            color: #4F46E5;
            background: #f3f4f6;
        }

        .pcd-tab.active {
            color: #4F46E5;
            background: #EEF2FF;
        }

        .pcd-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4F46E5;
        }

        /* Tab Content */
        .pcd-tab-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .pcd-tab-panel {
            display: none;
        }

        .pcd-tab-panel.active {
            display: block;
        }

        /* Milestones */
        .pcd-milestones {
            display: grid;
            gap: 20px;
        }

        .pcd-milestone {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .pcd-milestone.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .pcd-milestone.current {
            border-color: #4F46E5;
            background: #EEF2FF;
        }

        .pcd-milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .pcd-milestone-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .pcd-milestone-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .pcd-milestone.completed .pcd-milestone-status {
            background: #10b981;
            color: white;
        }

        .pcd-milestone.current .pcd-milestone-status {
            background: #4F46E5;
            color: white;
        }

        .pcd-milestone.upcoming .pcd-milestone-status {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* Canvas Container */
        .pcd-canvas-container {
            position: relative;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pcd-canvas-placeholder {
            text-align: center;
            color: #6b7280;
        }

        .pcd-canvas-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Messages */
        .pcd-messages-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .pcd-message-item {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .pcd-message-item:last-child {
            border-bottom: none;
        }

        .pcd-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .pcd-message-sender {
            font-weight: 600;
            color: #1f2937;
        }

        .pcd-message-time {
            font-size: 12px;
            color: #6b7280;
        }

        .pcd-message-body {
            color: #4b5563;
            line-height: 1.5;
        }

        /* Empty State */
        .pcd-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .pcd-empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Loading State */
        .pcd-loading {
            text-align: center;
            padding: 60px 20px;
        }

        .pcd-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: #4F46E5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Authentication Form */
        .pcd-auth-container {
            max-width: 400px;
            margin: 40px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pcd-auth-container h2 {
            margin: 0 0 24px 0;
            text-align: center;
            color: #1f2937;
        }

        .pcd-auth-form input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .pcd-auth-form button {
            width: 100%;
            padding: 12px 16px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .pcd-auth-form button:hover {
            background: #4338CA;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .pcd-tabs {
                flex-direction: column;
            }

            .pcd-tab::after {
                display: none;
            }

            .pcd-status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="pcd-workspace" class="pcd-workspace">
        <!-- Loading State -->
        <div id="pcd-loading" class="pcd-loading">
            <div class="pcd-spinner"></div>
            <p>Loading your project...</p>
        </div>

        <!-- Authentication Form -->
        <div id="pcd-auth" class="pcd-auth-container" style="display: none;">
            <h2>Access Your Project</h2>
            <div class="pcd-auth-form">
                <input type="email" id="pcd-email" placeholder="Your email address">
                <input type="text" id="pcd-token" placeholder="Project token (optional)">
                <button onclick="PCDWorkspace.authenticate()">Access Project</button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="pcd-main" style="display: none;">
            <!-- Header -->
            <div class="pcd-header">
                <h1 id="pcd-project-name">Your Project</h1>
                <p id="pcd-project-description">Loading project details...</p>
            </div>

            <!-- Progress -->
            <div class="pcd-progress-container">
                <div class="pcd-progress-label">
                    <span>Project Progress</span>
                    <span id="pcd-progress-percent">0%</span>
                </div>
                <div class="pcd-progress-bar">
                    <div class="pcd-progress-fill" id="pcd-progress-fill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Status Cards -->
            <div class="pcd-status-grid">
                <div class="pcd-status-card">
                    <h3>Status</h3>
                    <div class="value" id="pcd-status">Active</div>
                </div>
                <div class="pcd-status-card">
                    <h3>Timeline</h3>
                    <div class="value" id="pcd-timeline">On Track</div>
                </div>
                <div class="pcd-status-card">
                    <h3>Next Milestone</h3>
                    <div class="value" id="pcd-next-milestone">Design Review</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="pcd-tabs">
                <button class="pcd-tab active" onclick="PCDWorkspace.switchTab('overview')">Overview</button>
                <button class="pcd-tab" onclick="PCDWorkspace.switchTab('canvas')">Design Canvas</button>
                <button class="pcd-tab" onclick="PCDWorkspace.switchTab('milestones')">Milestones</button>
                <button class="pcd-tab" onclick="PCDWorkspace.switchTab('messages')">Messages</button>
            </div>

            <!-- Tab Content -->
            <div class="pcd-tab-content">
                <!-- Overview Tab -->
                <div id="pcd-panel-overview" class="pcd-tab-panel active">
                    <h2>Project Overview</h2>
                    <div id="pcd-overview-content">
                        <p>Loading project information...</p>
                    </div>
                </div>

                <!-- Canvas Tab -->
                <div id="pcd-panel-canvas" class="pcd-tab-panel">
                    <h2>Design Canvas</h2>
                    <div class="pcd-canvas-container">
                        <div class="pcd-canvas-placeholder">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V5h14v14H5z"/>
                            </svg>
                            <p>Design canvas will appear here</p>
                        </div>
                    </div>
                </div>

                <!-- Milestones Tab -->
                <div id="pcd-panel-milestones" class="pcd-tab-panel">
                    <h2>Project Milestones</h2>
                    <div class="pcd-milestones" id="pcd-milestones-list">
                        <div class="pcd-empty-state">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            <p>Loading milestones...</p>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div id="pcd-panel-messages" class="pcd-tab-panel">
                    <h2>Recent Messages</h2>
                    <div class="pcd-messages-list" id="pcd-messages-list">
                        <div class="pcd-empty-state">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                            </svg>
                            <p>No messages yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PCDWorkspace = {
            // Configuration
            config: {
                serverUrl: this.getServerUrl(),
                projectToken: null,
                projectData: null,
                memberInfo: null,
                socket: null
            },

            // Get appropriate server URL
            getServerUrl() {
                // Check for debug mode
                if (localStorage.getItem('pcd_debug_mode') === 'true') {
                    return 'http://localhost:3000';
                }

                // Check if running locally
                if (window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1') {
                    return 'http://localhost:3000';
                }

                // Production URL
                return 'https://pcd-production-clean-production-e6f3.up.railway.app';
            },

            // Initialize
            async init() {
                console.log('🚀 Initializing Pleasant Cove Workspace');
                
                // Hide loading
                document.getElementById('pcd-loading').style.display = 'none';
                
                // Check for Squarespace member
                this.detectSquarespaceMember();
                
                // Check for project token in URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (token) {
                    this.config.projectToken = token;
                    await this.loadProject();
                } else if (this.config.memberInfo) {
                    // Try to load project by member email
                    await this.loadProjectByEmail();
                } else {
                    // Show auth form
                    this.showAuth();
                }
                
                // Initialize WebSocket
                this.connectWebSocket();
            },

            // Detect Squarespace member
            detectSquarespaceMember() {
                // Check Static.SQUARESPACE_CONTEXT
                if (window.Static && window.Static.SQUARESPACE_CONTEXT) {
                    const ctx = window.Static.SQUARESPACE_CONTEXT;
                    if (ctx.authenticatedAccount) {
                        this.config.memberInfo = {
                            id: ctx.authenticatedAccount.id,
                            email: ctx.authenticatedAccount.email,
                            firstName: ctx.authenticatedAccount.firstName,
                            lastName: ctx.authenticatedAccount.lastName
                        };
                        return;
                    }
                }

                // Check SiteUserInfo cookie
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    if (cookie.trim().startsWith('SiteUserInfo=')) {
                        try {
                            const userInfo = JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                            if (userInfo.authenticated) {
                                this.config.memberInfo = userInfo;
                                return;
                            }
                        } catch (e) {
                            console.error('Error parsing SiteUserInfo:', e);
                        }
                    }
                }
            },

            // Connect WebSocket
            connectWebSocket() {
                const wsUrl = this.config.serverUrl.replace('http', 'ws');
                this.config.socket = new WebSocket(`${wsUrl}/ws`);

                this.config.socket.onopen = () => {
                    console.log('✅ WebSocket connected');
                    
                    // Join project room
                    if (this.config.projectToken) {
                        this.config.socket.send(JSON.stringify({
                            type: 'join_room',
                            room: `project_${this.config.projectToken}`
                        }));
                    }
                };

                this.config.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.config.socket.onclose = () => {
                    console.log('❌ WebSocket disconnected');
                    // Reconnect after 5 seconds
                    setTimeout(() => this.connectWebSocket(), 5000);
                };
            },

            // Handle WebSocket messages
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'project:update':
                        this.updateProjectData(data.project);
                        break;
                    case 'milestone:update':
                        this.updateMilestones();
                        break;
                    case 'message:new':
                        this.addMessage(data.message);
                        break;
                }
            },

            // Show auth form
            showAuth() {
                document.getElementById('pcd-auth').style.display = 'block';
                document.getElementById('pcd-main').style.display = 'none';
                
                // Pre-fill email if we have member info
                if (this.config.memberInfo && this.config.memberInfo.email) {
                    document.getElementById('pcd-email').value = this.config.memberInfo.email;
                }
            },

            // Authenticate
            async authenticate() {
                const email = document.getElementById('pcd-email').value;
                const token = document.getElementById('pcd-token').value;

                if (!email && !token) {
                    alert('Please enter your email or project token');
                    return;
                }

                try {
                    const response = await fetch(`${this.config.serverUrl}/api/auth/workspace`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            email, 
                            token,
                            squarespaceMemberId: this.config.memberInfo?.id 
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.config.projectToken = data.projectToken;
                        await this.loadProject();
                    } else {
                        alert(data.message || 'Authentication failed');
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    alert('Failed to authenticate. Please try again.');
                }
            },

            // Load project by email
            async loadProjectByEmail() {
                try {
                    const response = await fetch(
                        `${this.config.serverUrl}/api/projects/by-email/${this.config.memberInfo.email}`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.config.projectToken = data.token;
                        await this.loadProject();
                    } else {
                        this.showAuth();
                    }
                } catch (error) {
                    console.error('Error loading project by email:', error);
                    this.showAuth();
                }
            },

            // Load project data
            async loadProject() {
                try {
                    const response = await fetch(
                        `${this.config.serverUrl}/api/projects/${this.config.projectToken}`
                    );
                    
                    if (!response.ok) {
                        throw new Error('Project not found');
                    }
                    
                    const project = await response.json();
                    this.config.projectData = project;
                    
                    // Show main workspace
                    document.getElementById('pcd-auth').style.display = 'none';
                    document.getElementById('pcd-main').style.display = 'block';
                    
                    // Update UI
                    this.updateProjectData(project);
                    
                    // Load additional data
                    await Promise.all([
                        this.loadMilestones(),
                        this.loadMessages()
                    ]);
                    
                } catch (error) {
                    console.error('Error loading project:', error);
                    alert('Failed to load project. Please check your credentials.');
                    this.showAuth();
                }
            },

            // Update project data in UI
            updateProjectData(project) {
                // Update header
                document.getElementById('pcd-project-name').textContent = 
                    project.name || 'Your Project';
                document.getElementById('pcd-project-description').textContent = 
                    project.description || 'Web design and development project';
                
                // Update progress
                const progress = project.progress || 0;
                document.getElementById('pcd-progress-percent').textContent = `${progress}%`;
                document.getElementById('pcd-progress-fill').style.width = `${progress}%`;
                
                // Update status cards
                document.getElementById('pcd-status').textContent = 
                    this.formatStatus(project.status);
                document.getElementById('pcd-timeline').textContent = 
                    this.getTimelineStatus(project);
                
                // Update overview
                this.updateOverview(project);
            },

            // Format status
            formatStatus(status) {
                const statusMap = {
                    'active': 'Active',
                    'pending': 'Pending',
                    'completed': 'Completed',
                    'on_hold': 'On Hold'
                };
                return statusMap[status] || 'Active';
            },

            // Get timeline status
            getTimelineStatus(project) {
                if (!project.timeline) return 'On Track';
                
                const now = new Date();
                const deadline = new Date(project.timeline.deadline);
                const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (daysLeft < 0) return 'Overdue';
                if (daysLeft < 7) return `${daysLeft} days left`;
                return 'On Track';
            },

            // Update overview
            updateOverview(project) {
                const content = document.getElementById('pcd-overview-content');
                content.innerHTML = `
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3>Project Details</h3>
                            <p><strong>Type:</strong> ${project.type || 'Website Design'}</p>
                            <p><strong>Started:</strong> ${this.formatDate(project.createdAt)}</p>
                            <p><strong>Deadline:</strong> ${this.formatDate(project.timeline?.deadline)}</p>
                        </div>
                        <div>
                            <h3>Current Focus</h3>
                            <p>${project.currentFocus || 'Working on initial design concepts and gathering requirements.'}</p>
                        </div>
                        <div>
                            <h3>Recent Updates</h3>
                            <ul>
                                ${this.getRecentUpdates(project).map(update => 
                                    `<li>${update}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            },

            // Get recent updates
            getRecentUpdates(project) {
                // This would come from the project data
                return [
                    'Design mockups completed',
                    'Color scheme approved',
                    'Content structure defined'
                ];
            },

            // Load milestones
            async loadMilestones() {
                try {
                    const response = await fetch(
                        `${this.config.serverUrl}/api/projects/${this.config.projectToken}/milestones`
                    );
                    
                    const milestones = await response.json();
                    this.displayMilestones(milestones);
                    
                    // Update next milestone
                    const nextMilestone = milestones.find(m => m.status === 'current');
                    if (nextMilestone) {
                        document.getElementById('pcd-next-milestone').textContent = 
                            nextMilestone.title;
                    }
                } catch (error) {
                    console.error('Error loading milestones:', error);
                }
            },

            // Display milestones
            displayMilestones(milestones) {
                const container = document.getElementById('pcd-milestones-list');
                
                if (!milestones || milestones.length === 0) {
                    return;
                }
                
                container.innerHTML = milestones.map(milestone => `
                    <div class="pcd-milestone ${milestone.status}">
                        <div class="pcd-milestone-header">
                            <div class="pcd-milestone-title">${milestone.title}</div>
                            <div class="pcd-milestone-status">
                                ${this.formatMilestoneStatus(milestone.status)}
                            </div>
                        </div>
                        <p>${milestone.description}</p>
                        ${milestone.dueDate ? `<p><small>Due: ${this.formatDate(milestone.dueDate)}</small></p>` : ''}
                    </div>
                `).join('');
            },

            // Format milestone status
            formatMilestoneStatus(status) {
                const statusMap = {
                    'completed': 'Completed',
                    'current': 'In Progress',
                    'upcoming': 'Upcoming'
                };
                return statusMap[status] || status;
            },

            // Load messages
            async loadMessages() {
                try {
                    const response = await fetch(
                        `${this.config.serverUrl}/api/projects/${this.config.projectToken}/messages?limit=10`
                    );
                    
                    const messages = await response.json();
                    this.displayMessages(messages);
                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            },

            // Display messages
            displayMessages(messages) {
                const container = document.getElementById('pcd-messages-list');
                
                if (!messages || messages.length === 0) {
                    return;
                }
                
                container.innerHTML = messages.map(message => `
                    <div class="pcd-message-item">
                        <div class="pcd-message-header">
                            <span class="pcd-message-sender">${message.sender}</span>
                            <span class="pcd-message-time">${this.formatTime(message.createdAt)}</span>
                        </div>
                        <div class="pcd-message-body">${message.body}</div>
                    </div>
                `).join('');
            },

            // Add new message
            addMessage(message) {
                const container = document.getElementById('pcd-messages-list');
                const messageHtml = `
                    <div class="pcd-message-item">
                        <div class="pcd-message-header">
                            <span class="pcd-message-sender">${message.sender}</span>
                            <span class="pcd-message-time">Just now</span>
                        </div>
                        <div class="pcd-message-body">${message.body}</div>
                    </div>
                `;
                
                // Remove empty state if present
                const emptyState = container.querySelector('.pcd-empty-state');
                if (emptyState) {
                    container.innerHTML = '';
                }
                
                // Add new message at the top
                container.insertAdjacentHTML('afterbegin', messageHtml);
            },

            // Switch tabs
            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.pcd-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Update panels
                document.querySelectorAll('.pcd-tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`pcd-panel-${tabName}`).classList.add('active');
            },

            // Format date
            formatDate(dateString) {
                if (!dateString) return 'Not set';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            },

            // Format time
            formatTime(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) return 'Just now';
                if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
                
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => PCDWorkspace.init());
        } else {
            PCDWorkspace.init();
        }
    </script>
</body>
</html>
