# ğŸš€ Production Deployment Guide

## âœ… System Upgrade Summary

Your messaging system has been upgraded to production-ready with:

- **âœ… PostgreSQL Database** - True persistence across restarts
- **âœ… Cloudflare R2 Storage** - Reliable file uploads and storage  
- **âœ… Hybrid Storage System** - Falls back gracefully for development
- **âœ… Stable Token System** - No more random token generation

## ğŸ—ï¸ Railway Production Setup

### 1. Add PostgreSQL Plugin

In your Railway dashboard:

1. Go to your project
2. Click "Add Service" â†’ "Database" â†’ "PostgreSQL"
3. Railway will auto-generate a `DATABASE_URL` environment variable

### 2. Environment Variables

Add these to your Railway project environment variables:

```bash
# Database (auto-generated by Railway PostgreSQL plugin)
DATABASE_URL=postgresql://postgres:password@host:5432/database

# Admin Authentication
ADMIN_TOKEN=your_secure_production_admin_token_here

# Cloudflare R2 Storage (already configured)
R2_BUCKET=pleasantcovedesignuploads
R2_ENDPOINT=https://e0c2345ca2f693d3eef9b287a9adcd64.r2.cloudflarestorage.com
R2_REGION=auto
R2_ACCESS_KEY_ID=841c05486ccb4aa347155fd570abe30f
R2_SECRET_ACCESS_KEY=4c77f8d264c34efac9260e3234d8a48142bc2df5c4e086984331f67e82e89a13

# Server Configuration
NODE_ENV=production
PORT=3000
```

### 3. Deploy Commands

Railway will automatically run these on deployment:

```bash
npm run db:generate     # Generate Prisma client
npm run db:migrate:prod # Run database migrations
npm run db:seed         # Seed with initial data
npm start              # Start production server
```

### 4. Update Package.json Scripts

Already added to `package.json`:

```json
{
  "scripts": {
    "db:migrate": "npx prisma migrate dev",
    "db:migrate:prod": "npx prisma migrate deploy", 
    "db:generate": "npx prisma generate",
    "db:seed": "npx tsx prisma/seed.ts",
    "db:setup": "npm run db:generate && npm run db:migrate && npm run db:seed"
  }
}
```

## ğŸ§ª Current Test Status

### âœ… Working Features

**Messaging System:**
- âœ… GET `/api/public/project/test-project-token-123/messages` - Returns message history
- âœ… POST messages with content and file attachments
- âœ… Real-time polling for new messages
- âœ… Stable test token: `test-project-token-123`

**File Uploads:**
- âœ… GET `/api/public/project/:token/upload-url` - Generates R2 presigned URLs
- âœ… Direct upload to Cloudflare R2 storage
- âœ… Attachment keys stored in message records

**Admin Dashboard:**
- âœ… GET `/api/stats` - Returns business statistics
- âœ… Protected admin endpoints with Bearer token auth
- âœ… All CRUD operations for businesses, projects, activities

**Hybrid Storage:**
- âœ… Uses PostgreSQL when available (production)
- âœ… Falls back to in-memory storage (development)
- âœ… Seamless transition between storage systems

## ğŸ”„ Migration Process

When you deploy to Railway with PostgreSQL:

1. **First Deploy**: Hybrid storage detects PostgreSQL unavailable, uses in-memory
2. **Add PostgreSQL Plugin**: Railway provides `DATABASE_URL`
3. **Redeploy**: System detects PostgreSQL, runs migrations and seed automatically
4. **All Data Persists**: Messages, projects, companies survive restarts

## ğŸ“Š Production Benefits

### Before (In-Memory)
- âŒ Data lost on every restart  
- âŒ Random tokens broke client connections
- âŒ File uploads used memory fallback
- âŒ No persistence between deploys

### After (PostgreSQL + R2)
- âœ… **True persistence** across restarts
- âœ… **Stable tokens** - clients stay connected
- âœ… **Reliable file storage** via Cloudflare R2
- âœ… **Scalable** database with relationships
- âœ… **Professional file URLs** from R2 CDN

## ğŸ§ª Testing the Upgrade

### Test Message API
```bash
curl "https://your-app.up.railway.app/api/public/project/test-project-token-123/messages"
```

### Test File Upload
```bash
curl "https://your-app.up.railway.app/api/public/project/test-project-token-123/upload-url?filename=test.pdf&fileType=application/pdf"
```

### Test Admin Stats
```bash  
curl -H "Authorization: Bearer your_admin_token" "https://your-app.up.railway.app/api/stats"
```

## ğŸš€ Next Steps

1. **Deploy to Railway** with PostgreSQL plugin
2. **Update Squarespace widget** to use production URL
3. **Test end-to-end** message flow with file uploads
4. **Monitor logs** for database connection confirmations

Your messaging system is now production-ready! ğŸ‰ 