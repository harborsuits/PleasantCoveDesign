# ðŸš€ Production Deployment Guide - Railway

**Created:** January 21, 2025  
**Status:** Ready for Production Deployment  
**Target Platform:** Railway with PostgreSQL + R2 Storage

## ðŸŽ¯ **PRE-DEPLOYMENT CHECKLIST**

### **âœ… Code Changes Completed**
- [x] PostgreSQL storage implementation ready
- [x] R2 file storage service created
- [x] Production environment configuration template
- [x] Widget build script for production URLs
- [x] Database seeding script
- [x] Railway deployment configuration
- [x] Image proxy with R2 fallback

### **ðŸ”§ Required Railway Services**
1. **Web Service** (Main application)
2. **PostgreSQL Database** (Data persistence)
3. **Environment Variables** (Configuration)

---

## ðŸ“‹ **STEP-BY-STEP DEPLOYMENT**

### **Step 1: Railway Project Setup**
```bash
# Install Railway CLI
npm install -g @railway/cli

# Login to Railway
railway login

# Create new project
railway new
```

### **Step 2: Add PostgreSQL Database**
1. Go to Railway dashboard
2. Click "Add Service" â†’ "Database" â†’ "PostgreSQL"
3. Wait for provisioning to complete
4. Copy the `DATABASE_URL` from the database service

### **Step 3: Configure Environment Variables**
In Railway dashboard, add these environment variables:

```bash
# Database (Auto-generated by Railway)
DATABASE_URL=postgresql://postgres:password@host:5432/database

# Server Configuration
NODE_ENV=production
PORT=3000

# CORS Configuration
CORS_ORIGINS=https://www.pleasantcovedesign.com,https://nectarine-sparrow-dwsp.squarespace.com

# Production URLs (Replace with your Railway URL)
FRONTEND_URL=https://your-railway-app.up.railway.app
API_BASE_URL=https://your-railway-app.up.railway.app/api
```

### **Step 4: Configure R2 Storage (Optional)**
If using Cloudflare R2 for file storage:

```bash
# Cloudflare R2 Configuration
R2_BUCKET=pleasantcovedesignuploads
R2_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
R2_REGION=auto
R2_ACCESS_KEY_ID=your_r2_access_key
R2_SECRET_ACCESS_KEY=your_r2_secret_key
```

### **Step 5: Deploy to Railway**
```bash
# Connect to Railway project
railway link

# Deploy the application
railway up

# Check deployment status
railway status

# View logs
railway logs
```

### **Step 6: Database Migration**
```bash
# Run database setup (creates tables and seeds data)
railway run npm run db:setup
```

### **Step 7: Build Production Widget**
```bash
# Set your Railway URL
export RAILWAY_URL=https://your-railway-app.up.railway.app

# Build production widget
npm run build:widget

# The production widget will be created at: dist/messaging-widget-production.html
```

### **Step 8: Deploy Widget to Squarespace**
1. Copy the contents of `dist/messaging-widget-production.html`
2. In Squarespace, go to Settings â†’ Advanced â†’ Code Injection
3. Paste the widget code in the **Footer** section
4. Save changes

---

## ðŸ§ª **TESTING & VERIFICATION**

### **Step 1: Health Check**
```bash
curl https://your-railway-app.up.railway.app/health
```
Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2025-01-21T...",
  "version": "1.1",
  "services": {
    "database": "connected",
    "webhooks": "active"
  }
}
```

### **Step 2: API Endpoint Test**
```bash
curl https://your-railway-app.up.railway.app/api/public/project/demo-project-token-123/messages
```

### **Step 3: Widget Integration Test**
1. Visit your Squarespace site
2. Open browser DevTools â†’ Console
3. Look for widget initialization messages
4. Send a test message
5. Check Railway logs for message processing

### **Step 4: Admin UI Test**
1. Visit `https://your-railway-app.up.railway.app/business/1/inbox`
2. Verify messages appear in admin interface
3. Test real-time updates

---

## ðŸ”§ **POST-DEPLOYMENT CONFIGURATION**

### **Custom Domain (Optional)**
1. In Railway dashboard, go to Settings â†’ Domains
2. Add your custom domain
3. Update widget URLs in Squarespace

### **SSL Certificate**
Railway automatically provides SSL certificates for all deployments.

### **Monitoring**
- Use Railway's built-in monitoring
- Check logs regularly: `railway logs --follow`
- Set up alerts for errors

---

## ðŸš¨ **TROUBLESHOOTING**

### **Common Issues**

1. **Database Connection Failed**
   ```bash
   # Check DATABASE_URL is set correctly
   railway variables
   
   # Test database connection
   railway run npm run db:migrate
   ```

2. **Widget Not Loading**
   - Check CORS_ORIGINS includes your Squarespace domain
   - Verify production widget URL is correct
   - Check browser console for errors

3. **Images Not Loading**
   - Verify R2 configuration if using cloud storage
   - Check image proxy endpoint: `/api/image-proxy/filename`

4. **WebSocket Connection Failed**
   - Railway Pro supports WebSockets automatically
   - Check firewall/proxy settings

### **Rollback Plan**
```bash
# View deployment history
railway deployments

# Rollback to previous deployment
railway rollback <deployment-id>
```

---

## ðŸ“Š **PRODUCTION MONITORING**

### **Key Metrics to Monitor**
- Response times
- Database connections
- Memory usage
- Error rates
- WebSocket connections

### **Log Monitoring**
```bash
# Follow real-time logs
railway logs --follow

# Filter by service
railway logs --service web

# Search logs
railway logs | grep ERROR
```

---

## ðŸŽ‰ **SUCCESS CRITERIA**

Your deployment is successful when:

- [x] Health check returns `200 OK`
- [x] Widget loads on Squarespace site
- [x] Messages send and receive successfully
- [x] Admin UI shows conversations
- [x] File uploads work (if configured)
- [x] Real-time updates function
- [x] No console errors in browser

---

## ðŸ“ž **SUPPORT**

If you encounter issues:

1. Check Railway logs: `railway logs`
2. Verify environment variables: `railway variables`
3. Test API endpoints manually
4. Check Squarespace console for widget errors
5. Review this guide for missed steps

**Remember:** This moves you from development to production. All customer conversations will now persist and be available 24/7! 