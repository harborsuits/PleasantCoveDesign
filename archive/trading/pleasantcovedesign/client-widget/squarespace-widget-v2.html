<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pleasant Cove Design - Public Messaging Widget</title>
    <style>
        /* Minimal widget styles */
        #pcd-widget {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 400px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .pcd-header {
            background: #000;
            color: white;
            padding: 16px;
            text-align: center;
        }

        .pcd-messages {
            height: 300px;
            overflow-y: auto;
            padding: 16px;
        }

        .pcd-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }

        .pcd-message.admin {
            background: #e3f2fd;
            margin-left: auto;
        }

        .pcd-message.client {
            background: #f5f5f5;
        }

        .pcd-input-area {
            border-top: 1px solid #eee;
            padding: 16px;
            display: flex;
            gap: 8px;
        }

        .pcd-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none;
        }

        .pcd-send-btn {
            padding: 8px 16px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .pcd-send-btn:hover {
            background: #005999;
        }

        .pcd-status {
            padding: 8px 16px;
            background: #f0f0f0;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="pcd-widget">
        <div class="pcd-header">
            <h3>Pleasant Cove Design</h3>
        </div>

        <div id="pcd-messages" class="pcd-messages">
            <div class="pcd-status">Connecting...</div>
        </div>

        <div class="pcd-input-area">
            <input type="text" id="pcd-input" class="pcd-input" placeholder="Type your message..." />
            <button id="pcd-send" class="pcd-send-btn">Send</button>
        </div>
    </div>

    <script>
        (function () {
            const API = "https://pcd-production-clean-production-e6f3.up.railway.app"; // Production API
            const WS = "wss://pcd-production-clean-production-e6f3.up.railway.app";   // WSS in prod!

            // Get project token from URL params or data attribute
            const tokenFromAttr = document.currentScript?.dataset?.projectToken;
            const tokenFromQS = new URLSearchParams(location.search).get("project_token");
            const PROJECT_TOKEN = tokenFromAttr || tokenFromQS;

            if (!PROJECT_TOKEN) {
                document.getElementById('pcd-messages').innerHTML = '<div class="pcd-status">Widget not configured</div>';
                return;
            }

            let wsToken = null;
            let projectId = null;
            let socket = null;

            // 1) Exchange project token for wsToken
            fetch(API + "/api/public/ws-exchange", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token: PROJECT_TOKEN }),
            })
            .then(r => r.json())
            .then(cfg => {
                if (!cfg.wsToken || !cfg.projectId) throw new Error("Invalid response");
                wsToken = cfg.wsToken;
                projectId = cfg.projectId;

                // 2) Connect Socket.IO
                socket = window.io(WS, {
                    path: "/socket.io",
                    transports: ["websocket"],
                    auth: { wsToken: wsToken },
                });

                // Schedule token refresh (15min = JWT expiry - 2min buffer)
                setTimeout(exchange, 13 * 60 * 1000);

                socket.on("connect", () => {
                    console.log("[PCD Widget] WS connected", socket.id);
                    updateStatus("Connected - send us a message!");

                    // Load existing messages on connect
                    loadMessages();
                });

                socket.on("connect_error", (e) => {
                    console.warn("[PCD Widget] WS error", e?.message);
                    updateStatus("Connection failed - please refresh");
                });

                socket.on("disconnect", (reason) => {
                    console.log("[PCD Widget] WS disconnect", reason);
                    updateStatus("Disconnected");

                    // Auto-reconnect on server disconnect (not client-initiated)
                    if (reason === "io server disconnect" || reason === "transport close") {
                        console.log("[PCD Widget] Server disconnect, refreshing token...");
                        setTimeout(() => exchange().catch(err => console.error("[PCD] Reconnect failed", err)), 1000);
                    }
                });

                // 3) Listen for new messages
                socket.on("message:new", (msg) => {
                    console.log("ðŸ“© message:new", msg);
                    addMessage(msg.content, msg.senderType === 'admin' ? 'admin' : 'client', msg.senderName);
                });

                // 4) Load existing messages
                loadMessages();
            })
            .catch(err => {
                console.error("[PCD Widget] Setup failed", err);
                updateStatus("Setup failed - check configuration");
            });

            function updateStatus(text) {
                const statusEl = document.querySelector('.pcd-status');
                if (statusEl) {
                    statusEl.textContent = text;
                }
            }

            function addMessage(text, type, sender = '') {
                const messagesEl = document.getElementById('pcd-messages');
                const statusEl = messagesEl.querySelector('.pcd-status');
                if (statusEl) statusEl.remove();

                const msgEl = document.createElement('div');
                msgEl.className = `pcd-message pcd-message-${type}`;
                msgEl.innerHTML = `<strong>${sender}:</strong> ${text}`;
                messagesEl.appendChild(msgEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            function loadMessages() {
                fetch(`${API}/api/public/project/${PROJECT_TOKEN}/messages?limit=20`)
                    .then(r => r.json())
                    .then(data => {
                        const messagesEl = document.getElementById('pcd-messages');
                        messagesEl.innerHTML = '';

                        if (data && data.items && Array.isArray(data.items)) {
                            data.items.reverse().forEach(msg => {
                                addMessage(msg.content, msg.senderType === 'admin' ? 'admin' : 'client', msg.senderName);
                            });
                        }

                        updateStatus("Connected - send us a message!");
                    })
                    .catch(err => {
                        console.error("[PCD Widget] Load messages failed", err);
                        updateStatus("Connected - send us a message!");
                    });
            }

            // Send message handler
            document.getElementById('pcd-send').addEventListener('click', sendMessage);
            document.getElementById('pcd-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            function sendMessage() {
                const input = document.getElementById('pcd-input');
                const text = input.value.trim();
                if (!text) return;

                // Optimistically add message
                addMessage(text, 'client', 'You');

                // Send via REST (Socket.IO will broadcast back)
                fetch(`${API}/api/public/project/${PROJECT_TOKEN}/messages`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text }),
                })
                .then(r => r.json())
                .then(() => {
                    input.value = '';
                })
                .catch(err => {
                    console.error("[PCD Widget] Send failed", err);
                    // Remove optimistic message and show error
                    const messages = document.querySelectorAll('.pcd-message');
                    if (messages.length > 0) {
                        messages[messages.length - 1].remove();
                    }
                    updateStatus("Send failed - please try again");
                    setTimeout(() => updateStatus("Connected"), 3000);
                });
            }

            // Make sendMessage available globally for debugging
            window.PCD_sendMessage = sendMessage;
        })();
    </script>

    <!-- Socket.IO Client -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"
            integrity="sha384-+6B8m8jTQ6e0N2w1+Vt5UQ4O3blQW7m4nkkwQ9l3s3qgkC0n9rF0Zx1RC3lVvJYy"
            crossorigin="anonymous"></script>
</body>
</html>
