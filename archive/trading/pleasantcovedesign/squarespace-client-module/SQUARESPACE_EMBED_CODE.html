<!-- 
PLEASANT COVE DESIGN - CLIENT PROJECT WORKSPACE
Copy this ENTIRE code and paste it into a Code Block on your Squarespace page
-->

<!-- Socket.IO for real-time updates -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<!-- Complete Project Workspace Module -->
<script>
(function() {
  'use strict';

  // CONFIGURATION - Change these URLs to match your server
  const API_URL = 'https://api.pleasantcovedesign.com';
  const WS_URL = 'wss://api.pleasantcovedesign.com';

  // Module styles
  const styles = `
    <style>
      #pcd-workspace {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        background: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }

      .pcd-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .pcd-header h2 {
        margin: 0 0 10px 0;
        font-size: 28px;
      }

      .pcd-header p {
        margin: 0;
        opacity: 0.9;
      }

      .pcd-tabs {
        display: flex;
        background: white;
        border-bottom: 2px solid #e2e8f0;
        overflow-x: auto;
      }

      .pcd-tab {
        padding: 15px 25px;
        background: none;
        border: none;
        color: #64748b;
        font-size: 16px;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s;
        border-bottom: 3px solid transparent;
      }

      .pcd-tab:hover {
        color: #667eea;
        background: #f8f9fa;
      }

      .pcd-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .pcd-content {
        padding: 30px;
        background: white;
        min-height: 400px;
      }

      .pcd-progress {
        margin-bottom: 30px;
      }

      .pcd-progress h3 {
        margin: 0 0 15px 0;
        color: #1f2937;
      }

      .pcd-progress-bar {
        width: 100%;
        height: 24px;
        background: #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
      }

      .pcd-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.5s ease;
      }

      .pcd-progress-text {
        margin-top: 10px;
        font-size: 18px;
        font-weight: 600;
        color: #667eea;
      }

      .pcd-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .pcd-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }

      .pcd-card h4 {
        margin: 0 0 10px 0;
        color: #1f2937;
      }

      .pcd-messages {
        display: flex;
        flex-direction: column;
        height: 500px;
      }

      .pcd-messages-list {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .pcd-message {
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word;
      }

      .pcd-message.client {
        background: #667eea;
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .pcd-message.team {
        background: white;
        color: #1f2937;
        border: 1px solid #e2e8f0;
      }

      .pcd-message-time {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .pcd-message-input {
        display: flex;
        gap: 10px;
      }

      .pcd-message-input input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .pcd-message-input input:focus {
        outline: none;
        border-color: #667eea;
      }

      .pcd-send-btn {
        padding: 12px 24px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
      }

      .pcd-send-btn:hover {
        background: #5a5ed8;
      }

      .pcd-milestone {
        display: flex;
        align-items: center;
        padding: 20px;
        margin-bottom: 15px;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.3s;
      }

      .pcd-milestone.completed {
        background: #f0fdf4;
        border-color: #86efac;
      }

      .pcd-milestone-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        font-size: 20px;
      }

      .pcd-milestone.completed .pcd-milestone-icon {
        background: #86efac;
        color: #166534;
      }

      .pcd-milestone.pending .pcd-milestone-icon {
        background: #e2e8f0;
        color: #64748b;
      }

      .pcd-milestone-content {
        flex: 1;
      }

      .pcd-milestone h4 {
        margin: 0 0 5px 0;
        color: #1f2937;
      }

      .pcd-milestone p {
        margin: 0;
        color: #64748b;
        font-size: 14px;
      }

      .pcd-file {
        display: flex;
        align-items: center;
        padding: 15px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s;
      }

      .pcd-file:hover {
        border-color: #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
      }

      .pcd-file-info {
        flex: 1;
      }

      .pcd-file-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 5px;
      }

      .pcd-file-meta {
        font-size: 14px;
        color: #64748b;
      }

      .pcd-download-btn {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
      }

      .pcd-loading {
        text-align: center;
        padding: 60px;
        color: #64748b;
      }

      .pcd-error {
        background: #fee2e2;
        color: #991b1b;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }

      .pcd-designs-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .pcd-design-item {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s;
      }

      .pcd-design-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      }

      .pcd-design-image {
        width: 100%;
        cursor: pointer;
      }

      .pcd-design-info {
        padding: 15px;
      }

      .pcd-design-name {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 5px;
      }

      .pcd-design-meta {
        font-size: 14px;
        color: #64748b;
      }

      @media (max-width: 768px) {
        .pcd-tabs {
          overflow-x: scroll;
        }
        
        .pcd-message {
          max-width: 85%;
        }
      }
    </style>
  `;

  // Initialize styles
  document.head.insertAdjacentHTML('beforeend', styles);

  // Main workspace object
  const PCD = {
    socket: null,
    project: null,
    memberInfo: null,
    currentTab: 'overview',

    init() {
      this.render();
      this.detectMember();
    },

    render() {
      const container = document.getElementById('pleasant-cove-workspace');
      if (!container) return;

      container.innerHTML = `
        <div id="pcd-workspace">
          <div class="pcd-header">
            <h2 id="pcd-project-name">Loading Your Project...</h2>
            <p id="pcd-company-name"></p>
          </div>
          
          <div class="pcd-tabs">
            <button class="pcd-tab active" onclick="PCD.showTab('overview')">Overview</button>
            <button class="pcd-tab" onclick="PCD.showTab('designs')">Designs</button>
            <button class="pcd-tab" onclick="PCD.showTab('messages')">Messages</button>
            <button class="pcd-tab" onclick="PCD.showTab('milestones')">Milestones</button>
            <button class="pcd-tab" onclick="PCD.showTab('files')">Files</button>
          </div>
          
          <div class="pcd-content" id="pcd-content">
            <div class="pcd-loading">Loading your project workspace...</div>
          </div>
        </div>
      `;
    },

    detectMember() {
      let memberInfo = null;

      // Check Squarespace context
      if (window.Static?.SQUARESPACE_CONTEXT?.authenticatedAccount) {
        const account = window.Static.SQUARESPACE_CONTEXT.authenticatedAccount;
        memberInfo = {
          id: account.id,
          email: account.email,
          name: `${account.firstName} ${account.lastName}`
        };
      }

      // Check URL params (for testing)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('member_email')) {
        memberInfo = {
          email: urlParams.get('member_email'),
          id: urlParams.get('member_id') || 'test',
          name: urlParams.get('member_name') || 'Test User'
        };
      }

      this.memberInfo = memberInfo;
      
      if (memberInfo) {
        this.loadProject();
      } else {
        this.showError('Please log in to your Squarespace account to view your project.');
      }
    },

    async loadProject() {
      try {
        const response = await fetch(`${API_URL}/api/workspace/member/${this.memberInfo.id}`);
        const data = await response.json();
        
        if (data.success && data.project) {
          this.project = data.project;
          this.updateHeader();
          this.connectWebSocket();
          this.showTab('overview');
        } else {
          this.showError('No active project found for your account.');
        }
      } catch (error) {
        console.error('Error loading project:', error);
        this.showError('Unable to connect to Pleasant Cove Design. Please try again later.');
      }
    },

    connectWebSocket() {
      if (!window.io) {
        console.warn('Socket.IO not loaded');
        return;
      }

      this.socket = io(WS_URL, {
        query: {
          projectId: this.project.id,
          memberEmail: this.memberInfo.email
        }
      });

      this.socket.on('connect', () => {
        console.log('Connected to Pleasant Cove Design');
      });

      this.socket.on('message:new', (message) => {
        if (this.currentTab === 'messages') {
          this.addMessageToUI(message);
        }
      });

      this.socket.on('project:updated', (update) => {
        Object.assign(this.project, update);
        if (this.currentTab === 'overview') {
          this.showTab('overview');
        }
      });
    },

    updateHeader() {
      document.getElementById('pcd-project-name').textContent = this.project.name || 'Your Project';
      document.getElementById('pcd-company-name').textContent = `Welcome, ${this.memberInfo.name}`;
    },

    showTab(tabName) {
      this.currentTab = tabName;
      
      // Update tab styles
      document.querySelectorAll('.pcd-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target?.classList.add('active');

      // Update content
      const contentDiv = document.getElementById('pcd-content');
      
      switch(tabName) {
        case 'overview':
          contentDiv.innerHTML = this.renderOverview();
          break;
        case 'designs':
          contentDiv.innerHTML = this.renderDesigns();
          break;
        case 'messages':
          contentDiv.innerHTML = this.renderMessages();
          break;
        case 'milestones':
          contentDiv.innerHTML = this.renderMilestones();
          break;
        case 'files':
          contentDiv.innerHTML = this.renderFiles();
          break;
      }
    },

    renderOverview() {
      const progress = this.project.progress || 0;
      return `
        <div class="pcd-progress">
          <h3>Project Progress</h3>
          <div class="pcd-progress-bar">
            <div class="pcd-progress-fill" style="width: ${progress}%"></div>
          </div>
          <div class="pcd-progress-text">${progress}% Complete</div>
        </div>
        
        <div class="pcd-grid">
          <div class="pcd-card">
            <h4>Current Stage</h4>
            <p style="font-size: 20px; color: #667eea;">${this.project.currentStage || 'Planning'}</p>
          </div>
          
          <div class="pcd-card">
            <h4>Estimated Completion</h4>
            <p style="font-size: 20px;">${this.formatDate(this.project.estimatedCompletion || this.project.dueDate)}</p>
          </div>
          
          <div class="pcd-card">
            <h4>Your Project Manager</h4>
            <p style="font-size: 18px;">Pleasant Cove Design Team</p>
            <p style="color: #64748b;">Available Mon-Fri 9AM-5PM EST</p>
          </div>
        </div>
      `;
    },

    renderDesigns() {
      if (!this.project.designs || this.project.designs.length === 0) {
        return '<p style="text-align: center; color: #64748b; padding: 40px;">No designs uploaded yet. Check back soon!</p>';
      }

      return `
        <h3>Your Design Concepts</h3>
        <p style="color: #64748b; margin-bottom: 20px;">Click on any design to view full size</p>
        <div class="pcd-designs-grid">
          ${this.project.designs.map(design => `
            <div class="pcd-design-item">
              <img src="${design.url}" alt="${design.name}" class="pcd-design-image" onclick="window.open('${design.url}', '_blank')">
              <div class="pcd-design-info">
                <div class="pcd-design-name">${design.name}</div>
                <div class="pcd-design-meta">Version ${design.version || 1}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    },

    renderMessages() {
      return `
        <div class="pcd-messages">
          <div class="pcd-messages-list" id="pcd-messages-list">
            ${this.project.messages ? this.project.messages.map(msg => this.renderMessage(msg)).join('') : '<p style="text-align: center; color: #64748b;">No messages yet. Start a conversation!</p>'}
          </div>
          
          <div class="pcd-message-input">
            <input type="text" id="pcd-message-text" placeholder="Type your message..." onkeypress="if(event.key==='Enter') PCD.sendMessage()">
            <button class="pcd-send-btn" onclick="PCD.sendMessage()">Send</button>
          </div>
        </div>
      `;
    },

    renderMessage(msg) {
      const isClient = msg.sender === 'client' || msg.senderEmail === this.memberInfo.email;
      return `
        <div class="pcd-message ${isClient ? 'client' : 'team'}">
          <strong>${msg.senderName || msg.sender}</strong><br>
          ${msg.content}
          <div class="pcd-message-time">${this.formatTime(msg.timestamp || msg.created_at)}</div>
        </div>
      `;
    },

    renderMilestones() {
      if (!this.project.milestones || this.project.milestones.length === 0) {
        return '<p style="text-align: center; color: #64748b; padding: 40px;">No milestones set for this project yet.</p>';
      }

      return `
        <h3>Project Milestones</h3>
        <div style="margin-top: 20px;">
          ${this.project.milestones.map(milestone => `
            <div class="pcd-milestone ${milestone.status === 'completed' ? 'completed' : 'pending'}">
              <div class="pcd-milestone-icon">
                ${milestone.status === 'completed' ? '✓' : '○'}
              </div>
              <div class="pcd-milestone-content">
                <h4>${milestone.title}</h4>
                <p>${milestone.description}</p>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    },

    renderFiles() {
      if (!this.project.files || this.project.files.length === 0) {
        return '<p style="text-align: center; color: #64748b; padding: 40px;">No files available yet.</p>';
      }

      return `
        <h3>Project Files</h3>
        <div style="margin-top: 20px;">
          ${this.project.files.map(file => `
            <div class="pcd-file">
              <div class="pcd-file-info">
                <div class="pcd-file-name">${file.name}</div>
                <div class="pcd-file-meta">${this.formatFileSize(file.size)} • ${this.formatDate(file.uploadedAt)}</div>
              </div>
              <a href="${file.url}" download class="pcd-download-btn">Download</a>
            </div>
          `).join('')}
        </div>
      `;
    },

    async sendMessage() {
      const input = document.getElementById('pcd-message-text');
      const message = input.value.trim();
      
      if (!message) return;

      try {
        const response = await fetch(`${API_URL}/api/workspace/project/${this.project.id}/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            projectId: this.project.id,
            memberId: this.memberInfo.id,
            memberEmail: this.memberInfo.email,
            memberName: this.memberInfo.name,
            content: message
          })
        });

        if (response.ok) {
          input.value = '';
        }
      } catch (error) {
        console.error('Error sending message:', error);
      }
    },

    addMessageToUI(message) {
      const messagesList = document.getElementById('pcd-messages-list');
      if (!messagesList) return;
      
      messagesList.insertAdjacentHTML('beforeend', this.renderMessage(message));
      messagesList.scrollTop = messagesList.scrollHeight;
    },

    showError(message) {
      document.getElementById('pcd-content').innerHTML = `
        <div class="pcd-error">${message}</div>
      `;
    },

    formatDate(dateString) {
      if (!dateString) return 'TBD';
      return new Date(dateString).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    },

    formatTime(dateString) {
      if (!dateString) return '';
      return new Date(dateString).toLocaleString('en-US', { 
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    },

    formatFileSize(bytes) {
      if (!bytes) return '0 KB';
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }
  };

  // Make PCD globally available
  window.PCD = PCD;

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => PCD.init());
  } else {
    PCD.init();
  }
})();
</script>

<!-- Container where the workspace will appear -->
<div id="pleasant-cove-workspace"></div>
